<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CYBER EXAM: PYTHON CORE</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=JetBrains+Mono:wght@400;700&family=Silkscreen&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>

    <style>
        :root {
            --bg-dark: #090a0f;
            --cyber-yellow: #fcee0a;
            --cyber-blue: #00f0ff;
            --cyber-red: #ff003c;
            --cyber-green: #00ff66;
            --cyber-orange: #ff8c00;
            --font-ui: 'Share Tech Mono', monospace;
            --font-code: 'JetBrains Mono', monospace;
            --font-header: 'Silkscreen', cursive;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg-dark);
            color: #e0e0e0; font-family: var(--font-ui);
            margin: 0; padding: 0; height: 100vh;
            display: flex; flex-direction: column; overflow: hidden;
            background-image: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0, 240, 255, 0.05) 3px);
        }

        /* OVERLAYS */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(9, 10, 15, 0.98); z-index: 9999;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center; text-align: center;
        }

        .glitch { font-family: var(--font-header); font-size: 3rem; color: var(--cyber-red); text-shadow: 3px 0 var(--cyber-blue), -3px 0 var(--cyber-yellow); animation: glitch-anim 0.2s infinite; }
        @keyframes glitch-anim { 0% { transform: translate(0) } 20% { transform: translate(-2px, 2px) } 40% { transform: translate(-2px, -2px) } 60% { transform: translate(2px, 2px) } 80% { transform: translate(2px, -2px) } 100% { transform: translate(0) } }

        input.cyber-input {
            background: #111; border: 2px solid var(--cyber-blue);
            color: #fff; padding: 15px; width: 300px; margin: 10px;
            font-family: var(--font-ui); font-size: 1.1rem; text-align: center;
        }
        input.cyber-input:focus { outline: none; box-shadow: 0 0 15px var(--cyber-blue); }

        .btn-cyber {
            background: var(--cyber-yellow); color: #000; border: none;
            padding: 15px 40px; font-family: var(--font-header); font-size: 1.2rem;
            cursor: pointer; margin-top: 20px; transition: 0.2s;
        }
        .btn-cyber:hover { background: var(--cyber-blue); box-shadow: 0 0 20px var(--cyber-blue); }

        /* LAYOUT */
        header {
            height: 70px; background: #000; border-bottom: 3px solid var(--cyber-red);
            display: flex; align-items: center; justify-content: space-between; padding: 0 30px;
        }
        h1 { font-family: var(--font-header); font-size: 1.5rem; margin: 0; color: var(--cyber-yellow); }
        .timer-box { font-size: 1.5rem; color: var(--cyber-red); font-family: var(--font-header); letter-spacing: 2px; }
        
        .workspace { display: flex; height: calc(100vh - 70px); }
        .problem-panel { width: 35%; background: rgba(0,0,0,0.8); border-right: 2px solid var(--cyber-blue); padding: 30px; overflow-y: auto; }
        .editor-panel { width: 65%; display: flex; flex-direction: column; background: #111; }
        
        textarea#code-editor {
            flex: 1; background: #111; color: var(--cyber-blue); border: none; padding: 20px;
            font-family: var(--font-code); font-size: 16px; resize: none; outline: none;
        }
        .terminal {
            height: 200px; background: #000; color: #fff; padding: 15px;
            font-family: var(--font-code); font-size: 0.9rem; border-top: 2px solid #333; overflow-y: auto;
        }
        .toolbar {
            height: 60px; background: #000; border-top: 2px solid var(--cyber-blue);
            display: flex; justify-content: flex-end; align-items: center; padding: 0 20px; gap: 15px;
        }
        
        .level-badge { background: var(--cyber-red); color: #fff; padding: 4px 10px; font-family: var(--font-header); }
        h2 { color: var(--cyber-blue); font-family: var(--font-header); font-size: 1.3rem; }

        .btn-run { background: var(--cyber-blue); color: #000; padding: 10px 20px; border: none; font-family: var(--font-header); cursor: pointer; }
        .btn-next { background: var(--cyber-green); color: #000; padding: 10px 20px; border: none; font-family: var(--font-header); cursor: pointer; display: none; }

        /* WARNING SCREEN (1st Offense) */
        #warning-screen { background: rgba(255, 140, 0, 0.95); color: #000; }
        
        /* LOCKDOWN SCREEN (2nd+ Offense) */
        #lockdown-screen { background: rgba(255, 0, 60, 0.95); color: #000; }
        .lock-timer { font-size: 5rem; font-family: var(--font-header); margin: 20px 0; }
    </style>
</head>
<body>

    <div id="login-screen" class="overlay">
        <h1 style="font-size: 2.5rem; color: var(--cyber-yellow); font-family: var(--font-header);">SMA GUNUNG MADU // CYBER EXAM</h1>
        <p style="color: var(--cyber-red); font-weight: bold;">[ ANTI-CHEAT ACTIVE ] REFRESH ATAU PINDAH TAB = LOCKDOWN 20 MENIT.</p>
        <input type="text" id="inp-nama" class="cyber-input" placeholder="NAMA LENGKAP" autocomplete="off">
        <input type="text" id="inp-kelas" class="cyber-input" placeholder="KELAS (Ex: XIA)" autocomplete="off">
        <button class="btn-cyber" onclick="initializeNewExam()">START EXAM</button>
    </div>

    <div id="loader" class="overlay" style="display:none;">
        <h2 class="glitch">CONNECTING TO MAINFRAME...</h2>
    </div>

    <div id="warning-screen" class="overlay" style="display:none;">
        <h1 style="font-size: 4rem; font-family: var(--font-header); margin: 0; color: #000;">STRICT WARNING</h1>
        <h2 style="color: #000;">SISTEM MENDETEKSI PERPINDAHAN TAB / APLIKASI.</h2>
        <p style="font-size: 1.2rem; font-weight: bold; max-width: 600px; color: #111;">
            Ini adalah peringatan pertama dan terakhir Anda. Jika Anda memindahkan tab, membuka aplikasi lain, atau meminimize browser lagi, terminal Anda akan DIKUNCI SELAMA 20 MENIT dan tidak bisa di-refresh.
        </p>
        <button class="btn-cyber" style="background: #000; color: var(--cyber-orange);" onclick="dismissWarning()">SAYA MENGERTI</button>
    </div>

    <div id="lockdown-screen" class="overlay" style="display:none;">
        <h1 style="font-size: 4rem; font-family: var(--font-header); margin: 0; color: #000;">SECURITY BREACH</h1>
        <h2 id="lockdown-warning" style="color: #000;">MULTIPLE TAB SWITCHING LOGGED.</h2>
        <div class="lock-timer" id="lock-timer">20:00</div>
        <p style="font-size: 1.2rem; font-weight: bold; color: #111;">TERMINAL LOCKED. REFRESHING THE PAGE WILL NOT RESET THIS TIMER.</p>
    </div>

    <header>
        <h1>FINAL EXAM // 15_NODE</h1>
        <div style="display: flex; gap: 30px; align-items: center;">
            <div style="color: var(--cyber-blue); font-weight: bold;">VIOLATIONS: <span id="violation-count">0</span></div>
            <div class="timer-box" id="main-timer">90:00</div>
        </div>
    </header>

    <div class="workspace">
        <div class="problem-panel">
            <span class="level-badge" id="lvl-badge">NODE 01/15</span>
            <h2 id="q-title">...</h2>
            <div id="q-desc" style="color:#aaa; line-height:1.6; font-size: 1.1rem;">...</div>
        </div>

        <div class="editor-panel">
            <textarea id="code-editor" spellcheck="false"></textarea>
            <div class="terminal" id="console">> TERMINAL_READY...</div>
            <div class="toolbar">
                <span id="status-msg" style="margin-right:auto; color:var(--cyber-blue)">Awaiting input...</span>
                <button class="btn-run" id="btn-run" onclick="runCode()">EXECUTE â–¶</button>
                <button class="btn-next" id="btn-next" onclick="nextQuestion()">NEXT NODE >></button>
            </div>
        </div>
    </div>

    <div id="result-screen" class="overlay" style="display:none;">
        <h1 style="font-size: 4rem; color: var(--cyber-green); font-family: var(--font-header);">EXAM COMPLETED</h1>
        <p style="font-size: 1.5rem;">FINAL SCORE: <span id="final-score" style="color:var(--cyber-yellow); font-weight: bold; font-size: 2rem;">0</span> / 1500</p>
        <p style="font-size: 1.2rem; color: var(--cyber-red);">TOTAL VIOLATIONS: <span id="final-violations">0</span></p>
        <div id="send-status" style="margin-top: 20px; color: var(--cyber-blue);">Uploading data to Server...</div>
    </div>

    <script>
        // --- SETUP GOOGLE SHEET URL ---
        // GANTI TULISAN DI BAWAH INI DENGAN URL WEB APP ANDA
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzfMlysRhY7kLOqIjxGmWcvFgwwa644vdf3Iy9PyWsGY6j41DbBCX0Ge5QYWknMVP6b/exec';

        let pyodide;
        let studentName = "", studentClass = "";
        
        let examEndTime = 0; 
        let lockEndTime = 0; 
        
        let examTimerInterval;
        let lockTimerInterval;
        
        let currentQ = 0;
        let score = 0;
        let violations = 0;
        
        let isExamActive = false;
        let isLocked = false;
        let isWarningOpen = false;
        let lastPenaltyTime = 0;

        // --- DATABASE SOAL (15 SOAL) ---
        const questions = [
            { title: "01. VARIABLES", desc: "Buat variabel <code>nama</code> berisi 'V' dan <code>level</code> berisi 50. Print keduanya.", default: "nama = \nlevel = \n\n# print keduanya", check: (c, o) => c.includes("nama") && c.includes("level") && o.includes("V") && o.includes("50") },
            { title: "02. ARITHMETIC 1", desc: "Buat variabel <code>a = 10</code> dan <code>b = 3</code>. Print hasil pertambahan (a+b) dan perkalian (a*b).", default: "a = 10\nb = 3\n", check: (c, o) => o.includes("13") && o.includes("30") },
            { title: "03. ARITHMETIC 2", desc: "Hitung dan print SISA BAGI (modulo) dari 100 dibagi 3.", default: "# Gunakan operator %\n", check: (c, o) => c.includes("%") && o.includes("1") },
            { title: "04. CONDITIONALS", desc: "Diberikan <code>hp = 15</code>. Buat if/else: jika hp di bawah 20 print 'Critical', jika tidak print 'Safe'.", default: "hp = 15\n# Buat if else\n", check: (c, o) => c.includes("if") && c.includes("else") && o.includes("Critical") },
            { title: "05. IF ELIF ELSE", desc: "Diberikan <code>skor = 75</code>. Jika skor >= 80 print 'A', jika >= 60 print 'B', selain itu print 'C'.", default: "skor = 75\n", check: (c, o) => c.includes("elif") && o.includes("B") },
            { title: "06. CREATE LIST", desc: "Buat list <code>senjata</code> yang berisi 'Katana', 'Pistol', 'Rifle'. Print list tersebut.", default: "senjata = ", check: (c, o) => c.includes("[") && o.includes("Katana") && o.includes("Rifle") },
            { title: "07. ACCESS LIST", desc: "Print item KEDUA dari list senjata tersebut.", default: "senjata = ['Katana', 'Pistol', 'Rifle']\n", check: (c, o) => c.includes("[1]") && o.includes("Pistol") && !o.includes("Katana") },
            { title: "08. APPEND LIST", desc: "Tambahkan 'Mantis' ke list senjata menggunakan method yang benar. Print hasilnya.", default: "senjata = ['Katana', 'Pistol']\n", check: (c, o) => c.includes(".append") && o.includes("Mantis") },
            { title: "09. REMOVE LIST", desc: "Hapus 'Pistol' dari list senjata. Print hasilnya.", default: "senjata = ['Katana', 'Pistol', 'Rifle']\n", check: (c, o) => c.includes(".remove") && !o.includes("Pistol") },
            { title: "10. LIST LENGTH", desc: "Print JUMLAH item dalam list menggunakan fungsi len().", default: "senjata = ['Katana', 'Pistol', 'Rifle', 'Mantis']\n", check: (c, o) => c.includes("len") && o.includes("4") },
            { title: "11. BASIC FOR LOOP", desc: "Gunakan for loop dengan <code>range()</code> untuk mem-print angka 1 sampai 5 secara vertikal.", default: "# for x in range(...):\n", check: (c, o) => c.includes("for") && c.includes("range") && o.includes("1") && o.includes("5") && !o.includes("6") },
            { title: "12. LOOPING LIST", desc: "Gunakan for loop untuk mem-print setiap item di dalam list <code>sistem</code>.", default: "sistem = ['Hacking', 'Stealth', 'Combat']\n", check: (c, o) => c.includes("for") && o.includes("Hacking") && o.includes("Combat") },
            { title: "13. LOOP & IF", desc: "Looping dari angka 1 hingga 5. Di dalam loop, jika angka genap print 'Genap', jika ganjil print 'Ganjil'.", default: "# Gunakan for dan if (angka % 2 == 0)\n", check: (c, o) => c.includes("for") && c.includes("if") && o.includes("Genap") && o.includes("Ganjil") },
            { title: "14. SUM ARRAY", desc: "Jumlahkan semua isi list <code>uang = [10, 20, 30]</code> dengan for loop. Print totalnya.", default: "uang = [10, 20, 30]\ntotal = 0\n# Lakukan loop\n\nprint(total)", check: (c, o) => c.includes("for") && c.includes("+") && o.includes("60") },
            { title: "15. BOSS: FILTER LIST", desc: "Disediakan list <code>data = [10, 80, 30, 90]</code>. Buat list kosong <code>lulus = []</code>. Lakukan loop, jika nilai > 50, masukkan (append) ke list lulus. Print list lulus.", default: "data = [10, 80, 30, 90]\nlulus = []\n\n# Loop, If, Append\n\nprint(lulus)", check: (c, o) => c.includes("for") && c.includes("if") && c.includes(".append") && o.includes("80") && o.includes("90") && !o.includes("10") }
        ];

        // --- CHECK LOCAL STORAGE ON LOAD ---
        window.onload = function() {
            if (localStorage.getItem("ce_active") === "true") {
                // Resume Exam
                studentName = localStorage.getItem("ce_name");
                studentClass = localStorage.getItem("ce_class");
                examEndTime = parseInt(localStorage.getItem("ce_examEnd"));
                currentQ = parseInt(localStorage.getItem("ce_currentQ"));
                score = parseInt(localStorage.getItem("ce_score"));
                violations = parseInt(localStorage.getItem("ce_violations")) || 0;
                
                document.getElementById("violation-count").innerText = violations;
                document.getElementById("login-screen").style.display = "none";
                document.getElementById("loader").style.display = "flex";

                initPython(true); 
            } else if (localStorage.getItem("ce_active") === "finished") {
                document.getElementById("login-screen").innerHTML = "<h1 style='color:var(--cyber-red)'>ANDA SUDAH MENYELESAIKAN UJIAN INI.</h1>";
            }
        };

        function initializeNewExam() {
            studentName = document.getElementById("inp-nama").value.trim();
            studentClass = document.getElementById("inp-kelas").value.trim();
            if(!studentName || !studentClass) return alert("Identitas wajib diisi.");

            // Set Local Storage
            localStorage.setItem("ce_active", "true");
            localStorage.setItem("ce_name", studentName);
            localStorage.setItem("ce_class", studentClass);
            localStorage.setItem("ce_score", "0");
            localStorage.setItem("ce_currentQ", "0");
            localStorage.setItem("ce_violations", "0");
            
            // WAKTU UJIAN: 90 Menit (5400 detik)
            examEndTime = Date.now() + (5400 * 1000);
            localStorage.setItem("ce_examEnd", examEndTime.toString());

            document.getElementById("login-screen").style.display = "none";
            document.getElementById("loader").style.display = "flex";

            initPython(false);
        }

        async function initPython(isResume) {
            try {
                pyodide = await loadPyodide();
                document.getElementById("loader").style.display = "none";
                isExamActive = true;
                
                startMainTimer();
                loadQuestion(currentQ);
                
                // EVENT LISTENER ANTI-CHEAT
                document.addEventListener('visibilitychange', handleVisibilityChange);
                window.addEventListener('blur', handleWindowBlur);

                // Jika saat direfresh dia masih dalam masa hukuman
                if (isResume) {
                    let savedLockEnd = parseInt(localStorage.getItem("ce_lockEnd")) || 0;
                    if (savedLockEnd > Date.now()) {
                        lockEndTime = savedLockEnd;
                        resumeLockdown();
                    }
                }

            } catch (err) {
                alert("SYSTEM FAILURE: Tidak dapat memuat compiler Python.");
            }
        }

        // --- ANTI CHEAT LOGIC ---
        function handleVisibilityChange() { if (document.hidden && isExamActive) applyPenalty(); }
        function handleWindowBlur() { if (isExamActive) applyPenalty(); }

        function applyPenalty() {
            let now = Date.now();
            if (now - lastPenaltyTime < 1000) return; // Debounce 1 detik
            lastPenaltyTime = now;

            violations++;
            localStorage.setItem("ce_violations", violations.toString());
            document.getElementById("violation-count").innerText = violations;

            if (violations === 1) {
                isWarningOpen = true;
                document.getElementById("warning-screen").style.display = "flex";
            } else {
                if(isWarningOpen) document.getElementById("warning-screen").style.display = "none";
                isWarningOpen = false;
                
                // Lockdown 20 Menit (1200 detik)
                lockEndTime = Date.now() + (1200 * 1000); 
                localStorage.setItem("ce_lockEnd", lockEndTime.toString());
                
                resumeLockdown(); 
            }
        }

        function dismissWarning() {
            document.getElementById("warning-screen").style.display = "none";
            isWarningOpen = false;
        }

        function resumeLockdown() {
            isLocked = true;
            document.getElementById("lockdown-screen").style.display = "flex";
            
            document.getElementById("lockdown-screen").style.background = "rgba(200, 0, 0, 0.95)";
            setTimeout(() => { document.getElementById("lockdown-screen").style.background = "rgba(255, 0, 60, 0.95)"; }, 150);

            clearInterval(lockTimerInterval); 
            updateLockTimerDisplay();

            lockTimerInterval = setInterval(() => {
                updateLockTimerDisplay();
                if(Date.now() >= lockEndTime) {
                    clearInterval(lockTimerInterval);
                    document.getElementById("lockdown-screen").style.display = "none";
                    isLocked = false;
                    localStorage.removeItem("ce_lockEnd"); 
                }
            }, 1000);
        }

        function updateLockTimerDisplay() {
            let timeLeft = Math.max(0, Math.floor((lockEndTime - Date.now()) / 1000));
            let m = Math.floor(timeLeft / 60).toString().padStart(2, '0');
            let s = (timeLeft % 60).toString().padStart(2, '0');
            document.getElementById('lock-timer').innerText = `${m}:${s}`;
        }

        // --- EXAM TIMER ---
        function startMainTimer() {
            examTimerInterval = setInterval(() => {
                let timeLeft = Math.max(0, Math.floor((examEndTime - Date.now()) / 1000));
                
                if(timeLeft <= 0) {
                    finishExam(); 
                } else {
                    let m = Math.floor(timeLeft / 60).toString().padStart(2, '0');
                    let s = (timeLeft % 60).toString().padStart(2, '0');
                    document.getElementById('main-timer').innerText = `${m}:${s}`;
                }
            }, 1000);
        }

        // --- QUESTION LOGIC ---
        function loadQuestion(idx) {
            const q = questions[idx];
            document.getElementById("lvl-badge").innerText = `NODE ${String(idx+1).padStart(2,'0')}/15`;
            document.getElementById("q-title").innerText = q.title;
            document.getElementById("q-desc").innerHTML = q.desc;
            document.getElementById("code-editor").value = q.default;
            
            document.getElementById("btn-next").style.display = "none";
            document.getElementById("btn-run").disabled = false;
            document.getElementById("console").innerText = "> Waiting for execution...";
            document.getElementById("status-msg").innerText = "Ready.";
            document.getElementById("status-msg").style.color = "var(--cyber-blue)";
        }

        async function runCode() {
            if(isLocked || isWarningOpen) return;

            const btn = document.getElementById("btn-run");
            const term = document.getElementById("console");
            const code = document.getElementById("code-editor").value;
            const q = questions[currentQ];
            
            btn.disabled = true; term.innerText = "> EXECUTING SCRIPT...";

            let script = `
import sys
from io import StringIO
sys.stdout = mystdout = StringIO()
try:
${code.split('\n').map(l=>'    '+l).join('\n')}
except Exception as e:
    print(f"Error: {e}")
mystdout.getvalue()`;

            try {
                let out = await pyodide.runPythonAsync(script);
                term.innerText = out;

                if(out.includes("Error:")) {
                    document.getElementById("status-msg").innerText = "[!] SYNTAX ERROR";
                    document.getElementById("status-msg").style.color = "var(--cyber-red)";
                } else if(q.check(code, out)) {
                    document.getElementById("status-msg").innerText = "[+] SCRIPT AUTHORIZED. ACCESS GRANTED.";
                    document.getElementById("status-msg").style.color = "var(--cyber-green)";
                    document.getElementById("btn-next").style.display = "inline-block";
                    
                    if(!q.completed) { 
                        score += 100; 
                        q.completed = true; 
                        localStorage.setItem("ce_score", score.toString());
                    } 
                } else {
                    document.getElementById("status-msg").innerText = "[-] OUTPUT INCORRECT OR LOGIC MISSING.";
                    document.getElementById("status-msg").style.color = "var(--cyber-yellow)";
                }
            } catch (e) {
                term.innerText = "CRITICAL ERROR: " + e;
            } finally {
                btn.disabled = false;
            }
        }

        function nextQuestion() {
            currentQ++;
            if(currentQ < questions.length) {
                localStorage.setItem("ce_currentQ", currentQ.toString());
                loadQuestion(currentQ);
            } else {
                finishExam();
            }
        }

        // --- SUBMISSION ---
        function finishExam() {
            isExamActive = false;
            clearInterval(examTimerInterval);
            clearInterval(lockTimerInterval);
            
            document.removeEventListener('visibilitychange', handleVisibilityChange);
            window.removeEventListener('blur', handleWindowBlur);

            document.getElementById("warning-screen").style.display = "none";
            document.getElementById("lockdown-screen").style.display = "none";

            // Mark Exam as Completed
            localStorage.setItem("ce_active", "finished");

            document.getElementById("result-screen").style.display = "flex";
            document.getElementById("final-score").innerText = score;
            document.getElementById("final-violations").innerText = violations;

            sendDataToSheet();
        }

        function sendDataToSheet() {
            const statusEl = document.getElementById("send-status");
            
            // 5400 adalah 90 menit dalam satuan detik
            let timeUsedSeconds = Math.max(0, 5400 - Math.floor((examEndTime - Date.now()) / 1000));
            let m = Math.floor(timeUsedSeconds / 60).toString().padStart(2, '0');
            let s = (timeUsedSeconds % 60).toString().padStart(2, '0');
            
            const payload = {
                nama: studentName,
                kelas: studentClass,
                skor: score,
                durasi: `${m}:${s}`,
                pelanggaran: violations
            };

            // BYPASS CORS SECURITY 
            fetch(GOOGLE_SCRIPT_URL, {
                method: "POST",
                mode: "no-cors", // <--- INI SANGAT PENTING AGAR TIDAK DIBLOKIR BROWSER
                headers: {
                    "Content-Type": "text/plain"
                },
                body: JSON.stringify(payload)
            })
            .then(() => {
                // Dalam mode no-cors, kita tidak bisa membaca respon Google, 
                // tapi jika sampai sini berarti data berhasil berangkat.
                statusEl.innerText = "[+] DATA UPLOADED TO SERVER.";
                statusEl.style.color = "var(--cyber-green)";
            })
            .catch(err => {
                statusEl.innerText = "[-] UPLOAD FAILED. SCREENSHOT THIS PAGE AS PROOF.";
                statusEl.style.color = "var(--cyber-red)";
                console.error("Fetch error:", err);
            });
        }
    </script>
</body>
</html>